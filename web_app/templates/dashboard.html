{% extends "base.html" %}

{% block title %}{{ t.dashboard if t else 'Gösterge Tablosu' }} - {{ t.header_title if t else '3D Yazıcı İzleme' }}{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block extra_css %}
<style>
/* Farm Dashboard Styles - Theme Aware */
.farm-dashboard {
    background: var(--bg-primary);
    min-height: calc(100vh - 60px);
    margin: -20px;
    margin-top: -10px;
    padding: 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.dashboard-header h2 {
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.dashboard-actions {
    display: flex;
    gap: 10px;
}

.dashboard-actions .btn {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* System Status Bar */
.system-status-bar {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.disk-usage {
    flex: 1;
    margin-right: 20px;
}

.disk-usage .progress {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
}

.disk-usage .progress-bar {
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
}

.disk-info {
    color: var(--text-secondary);
    font-size: 0.85rem;
    text-align: center;
}

/* Printer Cards Grid */
.printers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

/* Printer Card */
.printer-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.printer-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--accent-primary);
}

.printer-card-header {
    background: var(--bg-tertiary);
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.printer-card-header h5 {
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1rem;
}

.printer-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.printer-status-dot.online { background: var(--accent-success); }
.printer-status-dot.offline { background: var(--accent-danger); }
.printer-status-dot.printing { background: var(--accent-warning); animation: pulse-dot 1.5s infinite; }

@keyframes pulse-dot {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
    50% { opacity: 0.8; box-shadow: 0 0 0 5px rgba(255, 193, 7, 0); }
}

.printer-card-header .btn-settings {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 5px;
    cursor: pointer;
}

.printer-card-header .btn-settings:hover {
    color: var(--text-primary);
}

/* Temperature Chart Area */
.printer-chart-area {
    padding: 15px;
    height: 180px;
    position: relative;
    background: var(--bg-primary);
}

.temp-chart {
    width: 100%;
    height: 100%;
}

.chart-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.temp-labels {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.progress-labels {
    text-align: right;
}

/* Printer Status Info */
.printer-status-info {
    padding: 12px 15px;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.printer-status-info .status-text {
    color: var(--accent-primary);
    font-weight: 500;
}

/* Printer Card Footer */
.printer-card-footer {
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border-color);
}

.printer-card-footer a {
    color: var(--accent-primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.printer-card-footer a:hover {
    color: var(--text-primary);
}

/* Progress Bar in Card */
.printer-progress {
    padding: 0 15px 15px;
}

.printer-progress .progress {
    height: 20px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
}

.printer-progress .progress-bar {
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-inverse);
}

.printer-progress .progress-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Cameras Section */
.cameras-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-top: 20px;
}

.cameras-header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cameras-header h5 {
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.cameras-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    padding: 15px;
}

.camera-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.camera-feed {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: #000;
}

.camera-info {
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.camera-name {
    color: var(--text-primary);
    font-size: 0.9rem;
}

.camera-type {
    font-size: 0.7rem;
}

/* Add Printer Card */
.add-printer-card {
    background: var(--bg-card);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    cursor: pointer;
    transition: all 0.2s;
}

.add-printer-card:hover {
    border-color: var(--accent-primary);
    background: rgba(99, 102, 241, 0.1);
}

.add-printer-card i {
    font-size: 3rem;
    color: var(--accent-primary);
    margin-bottom: 15px;
}

.add-printer-card span {
    color: var(--text-secondary);
    font-size: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="farm-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2><i class="bi bi-grid-3x3-gap-fill"></i> {{ t.dashboard if t else 'Gösterge Tablosu' }}</h2>
        <div class="dashboard-actions">
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAllPrinters()">
                <i class="bi bi-arrow-clockwise"></i> {{ t.refresh if t else 'Yenile' }}
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleCameras()">
                <i class="bi bi-camera-video"></i> {{ t.cameras if t else 'Kameralar' }}
            </button>
            <a href="/printers" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> {{ t.add_printer if t else 'Yazıcı Ekle' }}
            </a>
        </div>
    </div>

    <!-- System Status Bar -->
    <div class="system-status-bar">
        <div class="disk-usage">
            <div class="progress">
                <div class="progress-bar" id="disk-progress" style="width: 45%"></div>
            </div>
        </div>
        <div class="disk-info">
            {{ t.free_disk if t else 'Boş disk alanı' }}: <span id="disk-free">50.4 GB</span>
        </div>
    </div>

    <!-- Printers Grid -->
    <div class="printers-grid" id="printers-grid">
        <!-- Printers will be loaded dynamically -->
        <div id="no-printers-message" class="text-center py-5" style="grid-column: 1 / -1;">
            <i class="bi bi-printer" style="font-size: 3rem; color: var(--text-muted);"></i>
            <p class="mt-3" style="color: var(--text-secondary);">{{ t.no_printers if t else 'Henüz yazıcı eklenmemiş' }}</p>
        </div>

        <!-- Add Printer Card -->
        <div class="add-printer-card" onclick="window.location.href='/printers'">
            <i class="bi bi-plus-circle"></i>
            <span>{{ t.add_printer if t else 'Yazıcı Ekle' }}</span>
        </div>
    </div>

    <!-- Cameras Section -->
    <div class="cameras-section" id="cameras-section" style="display: none;">
        <div class="cameras-header">
            <h5><i class="bi bi-camera-video"></i> {{ t.cameras if t else 'Kameralar' }}</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="addCamera()">
                <i class="bi bi-plus"></i> {{ t.add_camera if t else 'Kamera Ekle' }}
            </button>
        </div>
        <div class="cameras-grid" id="cameras-grid">
            <!-- Cameras will be loaded dynamically -->
            <div id="no-cameras-message" class="text-center py-4" style="grid-column: 1 / -1;">
                <i class="bi bi-camera-video-off" style="font-size: 2rem; color: var(--text-muted);"></i>
                <p class="mt-2" style="color: var(--text-secondary);">{{ t.no_cameras if t else 'Henüz kamera eklenmemiş' }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard Functions
function refreshAllPrinters() {
    // Refresh all printer data
    location.reload();
}

function toggleCameras() {
    const section = document.getElementById('cameras-section');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

function openPrinterSettings(printerId) {
    window.location.href = `/printers?edit=${printerId}`;
}

function addCamera() {
    window.location.href = '/printers?tab=cameras';
}

// Load printers from API
function loadPrinters() {
    fetch('/api/printers')
        .then(response => response.json())
        .then(data => {
            if (data.printers) {
                updatePrintersGrid(data.printers);
            }
        })
        .catch(err => console.log('Error loading printers:', err));
}

function updatePrintersGrid(printers) {
    // Update printer cards with real data
    printers.forEach(printer => {
        const card = document.querySelector(`[data-printer-id="${printer.id}"]`);
        if (card) {
            // Update status, temperatures, progress, etc.
        }
    });
}

// Update printer data periodically
function updatePrinterData() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update system stats
            if (data.system) {
                // Update disk usage if available
            }
        })
        .catch(err => console.log('Status update error'));
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadPrinters();
    
    // Update every 5 seconds
    setInterval(updatePrinterData, 5000);
});
</script>
{% endblock %}
