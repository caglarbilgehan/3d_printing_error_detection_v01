{% extends "base.html" %}

{% block title %}{{ t.printer_management if t else 'Yazıcı Yönetimi' }} - {{ t.header_title if t else '3D Yazıcı İzleme' }}{% endblock %}
{% block nav_printers %}active{% endblock %}

{% block extra_css %}
<style>
.printers-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.page-header h2 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Tabs */
.management-tabs {
    margin-bottom: 30px;
}

.management-tabs .nav-link {
    color: var(--text-secondary);
    border: none;
    border-bottom: 3px solid transparent;
    border-radius: 0;
    padding: 12px 20px;
}

.management-tabs .nav-link:hover {
    color: var(--text-primary);
    border-color: var(--border-color);
}

.management-tabs .nav-link.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
    background: transparent;
}

/* Printer List */
.printer-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
}

.printer-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s;
}

.printer-item:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--accent-primary);
}

.printer-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.printer-item-info h5 {
    margin: 0 0 5px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.printer-item-info .printer-type {
    font-size: 0.8rem;
}

.printer-item-actions {
    display: flex;
    gap: 5px;
}

.printer-item-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--bg-tertiary);
    border-radius: 8px;
}

.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-item .label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 2px;
}

.detail-item .value {
    font-weight: 500;
    color: var(--text-primary);
}

.printer-item-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.status-dot.online { background: var(--accent-success); }
.status-dot.offline { background: var(--accent-danger); }
.status-dot.printing { background: var(--accent-warning); animation: pulse 1.5s infinite; }

/* Camera List */
.camera-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.camera-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.camera-preview {
    height: 200px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.camera-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-preview .no-feed {
    text-align: center;
    color: var(--text-muted);
}

.camera-preview .no-feed i {
    font-size: 3rem;
    margin-bottom: 10px;
}

.camera-info {
    padding: 15px;
}

.camera-info h5 {
    margin: 0 0 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.camera-details {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.camera-details .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid var(--border-light);
}

.camera-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

/* Add Card */
.add-card {
    background: var(--bg-card);
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    cursor: pointer;
    transition: all 0.2s;
}

.add-card:hover {
    border-color: var(--accent-primary);
    background: rgba(78, 205, 196, 0.05);
}

.add-card i {
    font-size: 2.5rem;
    color: var(--accent-primary);
    margin-bottom: 10px;
}

.add-card span {
    color: var(--text-secondary);
}

/* Modal Styles */
.modal-dark .modal-content {
    background: var(--bg-card);
    border-color: var(--border-color);
}

.modal-dark .modal-header {
    border-color: var(--border-color);
}

.modal-dark .modal-footer {
    border-color: var(--border-color);
}

.form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.form-section h6 {
    margin-bottom: 15px;
    color: var(--accent-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Groups Section */
.groups-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.group-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
}

.group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.group-header h5 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.group-printers {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.group-printer-badge {
    background: var(--bg-tertiary);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.group-printer-badge .status-dot {
    width: 8px;
    height: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="printers-page">
    <!-- Page Header -->
    <div class="page-header">
        <h2><i class="bi bi-printer"></i> {{ t.printer_management if t else 'Yazıcı Yönetimi' }}</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="refreshAll()">
                <i class="bi bi-arrow-clockwise"></i> {{ t.refresh if t else 'Yenile' }}
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrinterModal">
                <i class="bi bi-plus-circle"></i> {{ t.add_printer if t else 'Yazıcı Ekle' }}
            </button>
        </div>
    </div>

    <!-- Management Tabs -->
    <ul class="nav management-tabs" id="managementTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#printers-tab">
                <i class="bi bi-printer"></i> {{ t.printers if t else 'Yazıcılar' }}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#cameras-tab">
                <i class="bi bi-camera-video"></i> {{ t.cameras if t else 'Kameralar' }}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#groups-tab">
                <i class="bi bi-collection"></i> {{ t.groups if t else 'Gruplar' }}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="managementTabContent">
        <!-- Printers Tab -->
        <div class="tab-pane fade show active" id="printers-tab">
            <div class="printer-list" id="printer-list">
                <!-- Printers will be loaded dynamically -->
                <div id="no-printers-message" class="text-center py-5">
                    <i class="bi bi-printer" style="font-size: 3rem; color: var(--text-muted);"></i>
                    <p class="mt-3" style="color: var(--text-secondary);">{{ t.no_printers if t else 'Henüz yazıcı eklenmemiş' }}</p>
                    <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addPrinterModal">
                        <i class="bi bi-plus-circle"></i> {{ t.add_printer if t else 'Yazıcı Ekle' }}
                    </button>
                </div>

                <!-- Add Printer Card -->
                <div class="add-card" data-bs-toggle="modal" data-bs-target="#addPrinterModal" style="display: none;" id="add-printer-card">
                    <i class="bi bi-plus-circle"></i>
                    <span>{{ t.add_printer if t else 'Yazıcı Ekle' }}</span>
                </div>
            </div>
        </div>

        <!-- Cameras Tab -->
        <div class="tab-pane fade" id="cameras-tab">
            <div class="camera-list" id="camera-list">
                <!-- Cameras will be loaded dynamically -->
                <div id="no-cameras-message" class="text-center py-5">
                    <i class="bi bi-camera-video" style="font-size: 3rem; color: var(--text-muted);"></i>
                    <p class="mt-3" style="color: var(--text-secondary);">{{ t.no_cameras if t else 'Henüz kamera eklenmemiş' }}</p>
                    <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                        <i class="bi bi-plus-circle"></i> {{ t.add_camera if t else 'Kamera Ekle' }}
                    </button>
                </div>

                <!-- Add Camera Card -->
                <div class="add-card" data-bs-toggle="modal" data-bs-target="#addCameraModal" style="display: none;" id="add-camera-card">
                    <i class="bi bi-plus-circle"></i>
                    <span>{{ t.add_camera if t else 'Kamera Ekle' }}</span>
                </div>
            </div>
        </div>

        <!-- Groups Tab -->
        <div class="tab-pane fade" id="groups-tab">
            <div class="groups-list" id="groups-list">
                <!-- Groups will be loaded dynamically -->
                <div id="no-groups-message" class="text-center py-5">
                    <i class="bi bi-collection" style="font-size: 3rem; color: var(--text-muted);"></i>
                    <p class="mt-3" style="color: var(--text-secondary);">{{ t.no_groups if t else 'Henüz grup oluşturulmamış' }}</p>
                    <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addGroupModal">
                        <i class="bi bi-plus-circle"></i> {{ t.add_group if t else 'Grup Ekle' }}
                    </button>
                </div>

                <!-- Add Group Card -->
                <div class="add-card" style="min-height: 100px; display: none;" data-bs-toggle="modal" data-bs-target="#addGroupModal" id="add-group-card">
                    <i class="bi bi-plus-circle"></i>
                    <span>{{ t.add_group if t else 'Grup Ekle' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Printer Modal -->
<div class="modal fade modal-dark" id="addPrinterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-printer"></i> {{ t.add_printer if t else 'Yazıcı Ekle' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPrinterForm">
                    <!-- Printer System Selection -->
                    <div class="form-section">
                        <h6><i class="bi bi-gear"></i> {{ t.printer_system if t else 'Yazıcı Sistemi' }}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ t.select_system if t else 'Sistem Seçin' }}</label>
                                <select class="form-select" name="printer_type" id="printerSystemSelect" required onchange="onSystemChange()">
                                    <option value="octoprint">OctoPrint</option>
                                    <option value="repetier">Repetier Server</option>
                                    <option value="klipper">Klipper / Moonraker</option>
                                    <option value="duet">Duet Web Control</option>
                                    <option value="custom">{{ t.custom if t else 'Özel / Diğer' }}</option>
                                </select>
                            </div>
                            <div class="col-12" id="systemDescription">
                                <div class="alert alert-info mb-0">
                                    <small><i class="bi bi-info-circle"></i> <span id="systemDescText">OctoPrint is a web interface for 3D printers</span></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Printer Info -->
                    <div class="form-section">
                        <h6><i class="bi bi-info-circle"></i> {{ t.printer_info if t else 'Yazıcı Bilgileri' }}</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ t.printer_name if t else 'Yazıcı Adı' }} *</label>
                                <input type="text" class="form-control" name="name" required placeholder="{{ t.example if t else 'Örn' }}: Yazıcı 1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.brand if t else 'Marka' }}</label>
                                <input type="text" class="form-control" name="brand" list="brandList" placeholder="{{ t.example if t else 'Örn' }}: Creality, Prusa, Voron">
                                <datalist id="brandList">
                                    <option value="Creality">
                                    <option value="Prusa">
                                    <option value="Voron">
                                    <option value="Anycubic">
                                    <option value="Artillery">
                                    <option value="Elegoo">
                                    <option value="Ender">
                                    <option value="Bambu Lab">
                                    <option value="Sovol">
                                    <option value="QIDI">
                                </datalist>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.model if t else 'Model' }}</label>
                                <input type="text" class="form-control" name="model" placeholder="{{ t.example if t else 'Örn' }}: Ender 3 Pro, MK3S+">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.serial_number if t else 'Seri Numarası' }}</label>
                                <input type="text" class="form-control" name="serial_number" placeholder="{{ t.optional if t else 'Opsiyonel' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Connection Settings -->
                    <div class="form-section">
                        <h6><i class="bi bi-wifi"></i> {{ t.connection if t else 'Bağlantı' }}</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ t.host if t else 'Host / IP' }} *</label>
                                <input type="text" class="form-control" name="host" required placeholder="192.168.1.100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">{{ t.port if t else 'Port' }} *</label>
                                <input type="number" class="form-control" name="port" id="portInput" required value="5000">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">{{ t.protocol if t else 'Protokol' }}</label>
                                <select class="form-select" name="ssl">
                                    <option value="false">HTTP</option>
                                    <option value="true">HTTPS</option>
                                </select>
                            </div>
                            <div class="col-12" id="apiKeySection">
                                <label class="form-label">API Key <span id="apiKeyRequired" class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="api_key" id="apiKeyInput" placeholder="">
                                <small class="text-muted" id="apiKeyHelp">{{ t.find_api_key if t else 'API Key konumu' }}: <span id="apiKeyLocation">Settings > API > Global API Key</span></small>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Settings -->
                    <div class="form-section">
                        <h6><i class="bi bi-camera-video"></i> {{ t.camera if t else 'Kamera' }}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ t.camera_url if t else 'Kamera URL' }}</label>
                                <input type="text" class="form-control" name="camera_url" id="cameraUrlInput" placeholder="">
                                <small class="text-muted">{{ t.camera_url_help if t else 'Boş bırakırsanız varsayılan URL kullanılır' }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Group Selection -->
                    <div class="form-section">
                        <h6><i class="bi bi-collection"></i> {{ t.group if t else 'Grup' }}</h6>
                        <select class="form-select" name="group_id">
                            <option value="">{{ t.no_group if t else 'Grup Yok' }}</option>
                            <option value="group_1">Ana Yazıcılar</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel if t else 'İptal' }}</button>
                <button type="button" class="btn btn-success" onclick="testConnection()">
                    <i class="bi bi-plug"></i> {{ t.test_connection if t else 'Bağlantıyı Test Et' }}
                </button>
                <button type="button" class="btn btn-primary" onclick="savePrinter()">
                    <i class="bi bi-check"></i> {{ t.save if t else 'Kaydet' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<div class="modal fade modal-dark" id="addCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-camera-video"></i> {{ t.add_camera if t else 'Kamera Ekle' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCameraForm">
                    <div class="form-section">
                        <h6><i class="bi bi-info-circle"></i> {{ t.basic_info if t else 'Temel Bilgiler' }}</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ t.camera_name if t else 'Kamera Adı' }}</label>
                                <input type="text" class="form-control" name="name" required placeholder="Ana Kamera">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.camera_type if t else 'Kamera Tipi' }}</label>
                                <select class="form-select" name="camera_type" required>
                                    <option value="mjpeg">MJPEG Stream</option>
                                    <option value="rtsp">RTSP Stream</option>
                                    <option value="hls">HLS Stream</option>
                                    <option value="snapshot">Snapshot (Anlık)</option>
                                    <option value="usb">USB Kamera</option>
                                    <option value="tuya">Tuya Kamera</option>
                                    <option value="onvif">ONVIF Kamera</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h6><i class="bi bi-link-45deg"></i> {{ t.stream_settings if t else 'Stream Ayarları' }}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ t.stream_url if t else 'Stream URL' }}</label>
                                <input type="text" class="form-control" name="url" required placeholder="http://192.168.1.100/webcam/?action=stream">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.username if t else 'Kullanıcı Adı' }} ({{ t.optional if t else 'Opsiyonel' }})</label>
                                <input type="text" class="form-control" name="username" placeholder="admin">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.password if t else 'Şifre' }} ({{ t.optional if t else 'Opsiyonel' }})</label>
                                <input type="password" class="form-control" name="password">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h6><i class="bi bi-printer"></i> {{ t.linked_printers if t else 'Bağlı Yazıcılar' }}</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="printers" value="printer_1" id="cam-printer-1">
                                    <label class="form-check-label" for="cam-printer-1">Ender 3 Pro</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="printers" value="printer_2" id="cam-printer-2">
                                    <label class="form-check-label" for="cam-printer-2">Prusa MK3S</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ t.position if t else 'Pozisyon' }}</label>
                                <select class="form-select" name="position">
                                    <option value="front">{{ t.front if t else 'Ön' }}</option>
                                    <option value="top">{{ t.top if t else 'Üst' }}</option>
                                    <option value="side">{{ t.side if t else 'Yan' }}</option>
                                    <option value="overview">{{ t.overview if t else 'Genel' }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel if t else 'İptal' }}</button>
                <button type="button" class="btn btn-success" onclick="testCamera()">
                    <i class="bi bi-eye"></i> {{ t.test_camera if t else 'Kamerayı Test Et' }}
                </button>
                <button type="button" class="btn btn-primary" onclick="saveCamera()">
                    <i class="bi bi-check"></i> {{ t.save if t else 'Kaydet' }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Printer Management Functions
function refreshAll() {
    location.reload();
}

// Printer system configurations cache
let printerSystemConfigs = {};

// Load printer system configurations on page load
function loadPrinterSystemConfigs() {
    fetch('/api/printer-systems')
        .then(response => response.json())
        .then(data => {
            printerSystemConfigs = data;
            // Apply initial system config
            onSystemChange();
        })
        .catch(err => console.log('Error loading printer systems:', err));
}

// Called when printer system dropdown changes
function onSystemChange() {
    const systemSelect = document.getElementById('printerSystemSelect');
    const selectedSystem = systemSelect.value;
    const config = printerSystemConfigs[selectedSystem];
    
    if (config) {
        // Update port
        document.getElementById('portInput').value = config.default_port;
        
        // Update description
        document.getElementById('systemDescText').textContent = config.description;
        
        // Update API key section
        const apiKeyRequired = document.getElementById('apiKeyRequired');
        const apiKeyLocation = document.getElementById('apiKeyLocation');
        const apiKeyInput = document.getElementById('apiKeyInput');
        
        if (config.api_key_required) {
            apiKeyRequired.style.display = 'inline';
            apiKeyInput.required = true;
        } else {
            apiKeyRequired.style.display = 'none';
            apiKeyInput.required = false;
        }
        apiKeyLocation.textContent = config.api_key_location;
        
        // Update camera URL placeholder
        const cameraInput = document.getElementById('cameraUrlInput');
        if (config.camera_path) {
            cameraInput.placeholder = `http://[host]:${config.default_port}${config.camera_path}`;
        } else {
            cameraInput.placeholder = '{{ t.enter_camera_url if t else "Kamera URL girin" }}';
        }
    }
    
    // Show/hide custom warning for custom system
    if (selectedSystem === 'custom') {
        document.getElementById('systemDescText').textContent = '{{ t.custom_system_warning if t else "Özel sistem - tüm ayarları manuel olarak yapılandırmanız gerekir" }}';
    }
}

// Initialize on modal show
document.getElementById('addPrinterModal')?.addEventListener('show.bs.modal', function() {
    if (Object.keys(printerSystemConfigs).length === 0) {
        loadPrinterSystemConfigs();
    } else {
        onSystemChange();
    }
});

// Load configs on page load
document.addEventListener('DOMContentLoaded', loadPrinterSystemConfigs);

function editPrinter(printerId) {
    // Load printer data and open modal
    fetch(`/api/printers/${printerId}`)
        .then(response => response.json())
        .then(data => {
            // Populate form with printer data
            const form = document.getElementById('addPrinterForm');
            form.querySelector('[name="name"]').value = data.name || '';
            form.querySelector('[name="brand"]').value = data.brand || '';
            form.querySelector('[name="model"]').value = data.model || '';
            form.querySelector('[name="serial_number"]').value = data.serial_number || '';
            form.querySelector('[name="host"]').value = data.host || '';
            form.querySelector('[name="port"]').value = data.port || 5000;
            form.querySelector('[name="api_key"]').value = data.api_key || '';
            form.querySelector('[name="camera_url"]').value = data.camera_url || '';
            form.querySelector('[name="printer_type"]').value = data.printer_type || 'octoprint';
            
            onSystemChange();
            
            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('addPrinterModal'));
            modal.show();
        });
}

function deletePrinter(printerId) {
    if (confirm('{{ t.confirm_delete_printer if t else "Bu yazıcıyı silmek istediğinizden emin misiniz?" }}')) {
        fetch(`/api/printers/${printerId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}

function testConnection() {
    const form = document.getElementById('addPrinterForm');
    const formData = new FormData(form);
    
    const testBtn = document.querySelector('[onclick="testConnection()"]');
    testBtn.disabled = true;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> {{ t.testing if t else "Test ediliyor..." }}';
    
    fetch('/api/printers/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-plug"></i> {{ t.test_connection if t else "Bağlantıyı Test Et" }}';
        
        if (data.success) {
            alert('{{ t.connection_success if t else "Bağlantı başarılı!" }} (' + data.state_text + ')');
        } else {
            alert('{{ t.connection_failed if t else "Bağlantı başarısız:" }} ' + (data.error || data.state_text));
        }
    })
    .catch(err => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-plug"></i> {{ t.test_connection if t else "Bağlantıyı Test Et" }}';
        alert('{{ t.connection_failed if t else "Bağlantı başarısız:" }} ' + err);
    });
}

function savePrinter() {
    const form = document.getElementById('addPrinterForm');
    const formData = new FormData(form);
    
    fetch('/api/printers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('{{ t.save_failed if t else "Kaydetme başarısız:" }} ' + data.error);
        }
    });
}

// Camera Management Functions
function editCamera(cameraId) {
    console.log('Edit camera:', cameraId);
}

function deleteCamera(cameraId) {
    if (confirm('{{ t.confirm_delete_camera if t else "Bu kamerayı silmek istediğinizden emin misiniz?" }}')) {
        fetch(`/api/cameras/${cameraId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}

function testCamera() {
    const url = document.querySelector('#addCameraForm input[name="url"]').value;
    window.open(url, '_blank', 'width=800,height=600');
}

function saveCamera() {
    const form = document.getElementById('addCameraForm');
    const formData = new FormData(form);
    
    // Get selected printers
    const printers = [];
    form.querySelectorAll('input[name="printers"]:checked').forEach(cb => {
        printers.push(cb.value);
    });
    
    const data = Object.fromEntries(formData);
    data.printer_ids = printers;
    
    fetch('/api/cameras', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('{{ t.save_failed if t else "Kaydetme başarısız:" }} ' + data.error);
        }
    });
}

// Group Management Functions
function editGroup(groupId) {
    console.log('Edit group:', groupId);
}

function deleteGroup(groupId) {
    if (confirm('{{ t.confirm_delete_group if t else "Bu grubu silmek istediğinizden emin misiniz?" }}')) {
        fetch(`/api/groups/${groupId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}
</script>
{% endblock %}
